trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra-aib/**
    exclude:
      - infra-aib/.terraform.lock.hcl

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: terraform-state-config
  - name: terraformVersion
    value: '1.14.3'
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)/infra-aib'
  - name: serviceConnection
    value: 'sp-ado-cuadmproj-containers'  

stages:
  - stage: CheckProviders
    displayName: 'Check Azure Provider Registration'
    jobs:
      - job: VerifyProviders
        displayName: 'Verify Required Providers'
        steps:
          - task: AzureCLI@2
            displayName: 'Check Azure Provider Registration Status'
            inputs:
              azureSubscription: '$(serviceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking Azure provider registration status..."
                echo ""
                
                # Define required providers
                PROVIDERS=(
                  "Microsoft.VirtualMachineImages"
                  "Microsoft.KeyVault"
                  "Microsoft.Compute"
                  "Microsoft.Storage"
                  "Microsoft.Network"
                  "Microsoft.ContainerInstance"
                )
                
                ALL_REGISTERED=true
                
                # Check each provider
                for PROVIDER in "${PROVIDERS[@]}"; do
                  echo "Checking provider: $PROVIDER"
                  STATE=$(az provider show -n "$PROVIDER" --query "registrationState" -o tsv)
                  echo "  Registration State: $STATE"
                  
                  if [ "$STATE" != "Registered" ]; then
                    echo "  ⚠️  WARNING: Provider $PROVIDER is not registered (State: $STATE)"
                    ALL_REGISTERED=false
                  else
                    echo "  ✓ Provider is registered"
                  fi
                  echo ""
                done
                
                if [ "$ALL_REGISTERED" = false ]; then
                  echo "##vso[task.logissue type=warning]Some Azure providers are not registered. Consider registering them with 'az provider register --namespace <provider-name>'"
                  echo ""
                  echo "To register all required providers, run:"
                  echo "az provider register --namespace Microsoft.VirtualMachineImages"
                  echo "az provider register --namespace Microsoft.KeyVault"
                  echo "az provider register --namespace Microsoft.Compute"
                  echo "az provider register --namespace Microsoft.Storage"
                  echo "az provider register --namespace Microsoft.Network"
                  echo "az provider register --namespace Microsoft.ContainerInstance"
                  exit 1
                else
                  echo "✓ All required Azure providers are registered"
                fi

  - stage: Validate
    displayName: 'Validate Terraform'
    dependsOn: CheckProviders
    jobs:
      - job: ValidateTerraform
        displayName: 'Terraform Validate'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: AzureCLI@2
            displayName: 'Setup Azure Authentication for Terraform'
            inputs:
              azureSubscription: '$(serviceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                echo "Setting up Azure authentication environment variables for Terraform OIDC..."
                
                # Export service principal details as environment variables
                echo "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=false]$servicePrincipalId"
                echo "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=false]$tenantId"
                echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID;issecret=false]$(az account show --query id -o tsv)"
                echo "##vso[task.setvariable variable=ARM_USE_OIDC;issecret=false]true"
                echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN;issecret=true]$idToken"
                
                echo "✓ Azure authentication variables configured"
                echo "  Client ID: $servicePrincipalId"
                echo "  Tenant ID: $tenantId"
                echo "  Subscription ID: $(az account show --query id -o tsv)"

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(workingDirectory)
              backendServiceArm: 'sp-ado-cuadmproj-containers'
              backendAzureRmResourceGroupName: $(tfStateResourceGroup)
              backendAzureRmStorageAccountName: $(tfStateStorageAccount)
              backendAzureRmContainerName: $(tfStateContainer)
              backendAzureRmKey: $(tfStateKey)
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_USE_OIDC: $(ARM_USE_OIDC)
              ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

          - task: TerraformTask@5
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: $(workingDirectory)
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_USE_OIDC: $(ARM_USE_OIDC)
              ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

          - task: TerraformTask@5
            displayName: 'Terraform Format Check'
            inputs:
              provider: 'azurerm'
              command: 'custom'
              customCommand: 'fmt'
              commandOptions: '-check -recursive'
              workingDirectory: $(workingDirectory)
              environmentServiceNameAzureRM: 'sp-ado-cuadmproj-containers'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_USE_OIDC: $(ARM_USE_OIDC)
              ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

  - stage: Plan
    displayName: 'Plan Infrastructure'
    dependsOn: Validate
    jobs:
      - job: TerraformPlan
        displayName: 'Terraform Plan'
        steps:
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: AzureCLI@2
            displayName: 'Setup Azure Authentication for Terraform'
            inputs:
              azureSubscription: '$(serviceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              addSpnToEnvironment: true
              inlineScript: |
                echo "Setting up Azure authentication environment variables for Terraform OIDC..."
                
                # Export service principal details as environment variables
                echo "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=false]$servicePrincipalId"
                echo "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=false]$tenantId"
                echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID;issecret=false]$(az account show --query id -o tsv)"
                echo "##vso[task.setvariable variable=ARM_USE_OIDC;issecret=false]true"
                echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN;issecret=true]$idToken"
                
                echo "✓ Azure authentication variables configured"
                echo "  Client ID: $servicePrincipalId"
                echo "  Tenant ID: $tenantId"
                echo "  Subscription ID: $(az account show --query id -o tsv)"

          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(workingDirectory)
              backendServiceArm: 'sp-ado-cuadmproj-containers'
              backendAzureRmResourceGroupName: $(tfStateResourceGroup)
              backendAzureRmStorageAccountName: $(tfStateStorageAccount)
              backendAzureRmContainerName: $(tfStateContainer)
              backendAzureRmKey: $(tfStateKey)
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_USE_OIDC: $(ARM_USE_OIDC)
              ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

          - task: TerraformTask@5
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: $(workingDirectory)
              commandOptions: '-out=tfplan'
              environmentServiceNameAzureRM: 'sp-ado-cuadmproj-containers'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_USE_OIDC: $(ARM_USE_OIDC)
              ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Plan Artifact'
            inputs:
              targetPath: '$(workingDirectory)/tfplan'
              artifact: 'tfplan'
              publishLocation: 'pipeline'

  - stage: Apply
    displayName: 'Deploy Infrastructure'
    dependsOn: Plan
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployInfrastructure
        displayName: 'Apply Terraform'
        environment: 'labs'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(terraformVersion)

                - task: AzureCLI@2
                  displayName: 'Setup Azure Authentication for Terraform'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    addSpnToEnvironment: true
                    inlineScript: |
                      echo "Setting up Azure authentication environment variables for Terraform OIDC..."
                      
                      # Export service principal details as environment variables
                      echo "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=false]$servicePrincipalId"
                      echo "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=false]$tenantId"
                      echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID;issecret=false]$(az account show --query id -o tsv)"
                      echo "##vso[task.setvariable variable=ARM_USE_OIDC;issecret=false]true"
                      echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN;issecret=true]$idToken"
                      
                      echo "✓ Azure authentication variables configured"
                      echo "  Client ID: $servicePrincipalId"
                      echo "  Tenant ID: $tenantId"
                      echo "  Subscription ID: $(az account show --query id -o tsv)"
                      
                      # Verify Azure CLI is working
                      echo ""
                      echo "Azure CLI Version:"
                      az --version

                - task: TerraformTask@5
                  displayName: 'Terraform Init'
                  inputs:
                    provider: 'azurerm'
                    command: 'init'
                    workingDirectory: $(workingDirectory)
                    backendServiceArm: 'sp-ado-cuadmproj-containers'
                    backendAzureRmResourceGroupName: $(tfStateResourceGroup)
                    backendAzureRmStorageAccountName: $(tfStateStorageAccount)
                    backendAzureRmContainerName: $(tfStateContainer)
                    backendAzureRmKey: $(tfStateKey)
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_USE_OIDC: $(ARM_USE_OIDC)
                    ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

                - task: TerraformTask@5
                  displayName: 'Terraform Apply'
                  inputs:
                    provider: 'azurerm'
                    command: 'apply'
                    workingDirectory: $(workingDirectory)
                    commandOptions: '-auto-approve'
                    environmentServiceNameAzureRM: 'sp-ado-cuadmproj-containers'
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_USE_OIDC: $(ARM_USE_OIDC)
                    ARM_OIDC_TOKEN: $(ARM_OIDC_TOKEN)

                - task: AzureCLI@2
                  displayName: 'Create Image Template'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    workingDirectory: $(workingDirectory)
                    inlineScript: |
                      echo "Creating Azure Image Builder template..."
                      
                      # Get Terraform outputs
                      RESOURCE_GROUP=$(terraform output -raw resource_group_name)
                      TEMPLATE_NAME=$(terraform output -raw image_template_resource_name)
                      TEMPLATE_FILE=$(terraform output -raw image_template_json_filename)
                      
                      # Create the Image Template resource
                      az resource create \
                        --resource-group "$RESOURCE_GROUP" \
                        --properties @"$TEMPLATE_FILE" \
                        --is-full-object \
                        --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                        --name "$TEMPLATE_NAME"
                      
                      echo "Image template '$TEMPLATE_NAME' created successfully"

                - task: AzureCLI@2
                  displayName: 'Build Custom Image'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    workingDirectory: $(workingDirectory)
                    inlineScript: |
                      echo "Starting image build process..."
                      
                      # Get Terraform outputs
                      RESOURCE_GROUP=$(terraform output -raw resource_group_name)
                      TEMPLATE_NAME=$(terraform output -raw image_template_resource_name)
                      
                      # Invoke the image build action
                      az resource invoke-action \
                        --resource-group "$RESOURCE_GROUP" \
                        --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                        --name "$TEMPLATE_NAME" \
                        --action Run
                      
                      echo "Image build triggered successfully for template '$TEMPLATE_NAME'"
                      echo "Note: The build process runs asynchronously and may take several minutes to complete."

                - task: AzureCLI@2
                  displayName: 'Check Image Build Status'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    workingDirectory: $(workingDirectory)
                    inlineScript: |
                      echo "Checking image template status..."
                      
                      # Get Terraform outputs
                      RESOURCE_GROUP=$(terraform output -raw resource_group_name)
                      TEMPLATE_NAME=$(terraform output -raw image_template_resource_name)
                      
                      # Check the template status
                      STATUS=$(az resource show \
                        --resource-group "$RESOURCE_GROUP" \
                        --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                        --name "$TEMPLATE_NAME" \
                        --query "properties.lastRunStatus.runState" -o tsv)
                      
                      echo "Current build status: $STATUS"
                      
                      # Optional: Wait for completion (can be commented out if you want async behavior)
                      # while [ "$STATUS" != "Succeeded" ] && [ "$STATUS" != "Failed" ]; do
                      #   echo "Build still in progress... waiting 30 seconds"
                      #   sleep 30
                      #   STATUS=$(az resource show \
                      #     --resource-group "$RESOURCE_GROUP" \
                      #     --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                      #     --name "$TEMPLATE_NAME" \
                      #     --query "properties.lastRunStatus.runState" -o tsv)
                      #   echo "Status: $STATUS"
                      # done
                      
                      if [ "$STATUS" == "Failed" ]; then
                        echo "##vso[task.logissue type=error]Image build failed"
                        exit 1
                      fi

                - task: AzureCLI@2
                  displayName: 'Cleanup Image Template Resources'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    workingDirectory: $(workingDirectory)
                    inlineScript: |
                      echo "Cleaning up image template staging resources..."
                      
                      # Get Terraform outputs
                      RESOURCE_GROUP=$(terraform output -raw resource_group_name)
                      TEMPLATE_NAME=$(terraform output -raw image_template_resource_name)
                      
                      # Check if template exists before attempting deletion
                      TEMPLATE_EXISTS=$(az resource list \
                        --resource-group "$RESOURCE_GROUP" \
                        --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                        --name "$TEMPLATE_NAME" \
                        --query "[0].id" -o tsv)
                      
                      if [ -n "$TEMPLATE_EXISTS" ]; then
                        echo "Deleting image template '$TEMPLATE_NAME'..."
                        az resource delete \
                          --resource-group "$RESOURCE_GROUP" \
                          --resource-type Microsoft.VirtualMachineImages/imageTemplates \
                          --name "$TEMPLATE_NAME"
                        
                        echo "✓ Image template '$TEMPLATE_NAME' deleted successfully"
                        echo "✓ Staging resources cleaned up"
                        echo "✓ Custom image remains available in the compute gallery"
                      else
                        echo "Image template '$TEMPLATE_NAME' not found. Skipping deletion."
                      fi